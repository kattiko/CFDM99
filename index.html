<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coordinate Remote Viewing</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 1000px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #1e3c72;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 0.9em;
        }

        .target-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .target-image {
            max-width: 300px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            margin: 20px auto;
            display: block;
        }

        .progress-bar {
            background: #f0f0f0;
            height: 30px;
            border-radius: 15px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #1e3c72 0%, #2a5298 100%);
            height: 100%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.85em;
        }

        .selection-info {
            text-align: center;
            margin: 20px 0;
            font-size: 1.1em;
            color: #333;
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .image-choice {
            cursor: pointer;
            border: 3px solid transparent;
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
        }

        .image-choice:hover {
            transform: scale(1.05);
            border-color: #1e3c72;
        }

        .image-choice.selected {
            border-color: #2a5298;
            box-shadow: 0 0 20px rgba(42, 82, 152, 0.5);
        }

        .image-choice img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
        }

        .btn {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 20px auto;
            font-weight: bold;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .results-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin-top: 30px;
        }

        .results-section h2 {
            color: #1e3c72;
            margin-bottom: 20px;
        }

        .stat-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #1e3c72;
        }

        .config-section {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #1e3c72;
        }

        .config-section input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        .config-section label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: bold;
            color: #1e3c72;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #1e3c72;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1e3c72;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #dc3545;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        #map {
            height: 500px;
            width: 100%;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .coordinate-display {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid #2a5298;
            font-family: monospace;
            font-size: 1.1em;
        }

        .coordinate-display.current {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .info-box {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #ffc107;
        }

        .input-group {
            margin: 15px 0;
        }

        .coordinate-input {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .toggle-stats-btn {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1em;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 15px auto;
            display: block;
            font-weight: bold;
        }

        .toggle-stats-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .statistics-section {
            background: #f0f8ff;
            padding: 30px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid #1e3c72;
        }

        .statistics-section h3 {
            color: #1e3c72;
            margin-bottom: 15px;
            margin-top: 20px;
        }

        .statistics-section h3:first-child {
            margin-top: 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .coord-item {
            background: white;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            border-left: 4px solid #1e3c72;
            font-family: monospace;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .coord-item:hover {
            background: #e3f2fd;
            transform: translateX(5px);
        }

        .coord-item .timestamp {
            font-size: 0.8em;
            color: #666;
            font-family: 'Segoe UI', sans-serif;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåç Coordinate Remote Viewing</h1>
        <p class="subtitle">Select coordinates through intuitive image choices</p>

        <!-- Configuration Section -->
        <div id="configSection" class="config-section">
            <h3>‚öôÔ∏è Setup</h3>
            
            <div class="input-group">
                <label>GitHub Repository Configuration</label>
                <input type="text" id="repoOwner" placeholder="Repository Owner (e.g., username)">
                <input type="text" id="repoName" placeholder="Repository Name">
                <input type="password" id="githubToken" placeholder="GitHub Token (optional for public repos)">
                <small>Create a token at <a href="https://github.com/settings/tokens" target="_blank">GitHub Settings</a> with 'repo' scope.</small>
            </div>

            <div class="input-group">
                <label>Target Coordinates (Center Point)</label>
                <div class="coordinate-input">
                    <input type="number" id="centerLat" step="0.000001" placeholder="Latitude (e.g., 60.1699)">
                    <input type="number" id="centerLon" step="0.000001" placeholder="Longitude (e.g., 24.9384)">
                </div>
                <small>The selection area will be a 5√ó5 km square centered on these coordinates</small>
            </div>

            <div class="input-group">
                <label>Target ID</label>
                <input type="text" id="targetId" placeholder="Enter a unique identifier for this target">
                <small>Use the same Target ID to group related viewing sessions</small>
            </div>

            <button class="btn" onclick="app.saveConfig()">Start Session</button>
        </div>

        <!-- Target Section -->
        <div id="targetSection" class="target-section hidden">
            <h2>Focus on the Target</h2>
            <div class="info-box">
                <strong>Target ID:</strong> <span id="displayTargetId"></span><br>
                <strong>Center Point:</strong> <span id="displayCenter"></span><br>
                <strong>Selection Area:</strong> 5√ó5 km (¬±2.5 km from center)
            </div>
            <img src="target.png" alt="Target" class="target-image" id="targetImage">
            <p>Clear your mind and focus on the target location. When ready, click below to begin.</p>
            <button class="btn" onclick="app.startSelection()">Click When Ready</button>
        </div>

        <!-- Preparation Section -->
        <div id="preparationSection" class="target-section hidden">
            <h2>Prepare for Selection</h2>
            <p style="font-size: 1.2em; margin: 30px 0;">Close your eyes and focus on the target location.</p>
            <p style="color: #666; margin-bottom: 30px;">When you feel ready, proceed to make your selection.</p>
            <button class="btn" onclick="app.proceedToSelection()">Proceed to Selection</button>
        </div>

        <!-- Selection Section -->
        <div id="selectionSection" class="hidden">
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar">0/12</div>
            </div>
            
            <div class="selection-info" id="selectionInfo">
                Select an image
            </div>

            <div class="image-grid" id="imageGrid"></div>

            <button class="btn" id="proceedBtn" onclick="app.proceedToNext()" disabled>Proceed to Next Selection</button>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden">
            <div class="loading" id="loadingResults">
                <div class="spinner"></div>
                <p>Analyzing your selection...</p>
            </div>
            <div id="resultsContent" class="hidden"></div>
            <button class="btn" onclick="app.reset()">Start New Session</button>
        </div>
    </div>

    <script>
        const app = {
            config: {
                owner: '',
                repo: '',
                token: '',
                centerLat: 0,
                centerLon: 0,
                targetId: ''
            },
            gameState: {
                selectedDigits: [],
                currentPool: [],
                currentSelection: null,
                selectionStep: 0,
                usedImages: [],
                pendingGroups: null,
                currentDigitIndex: 0
            },
            availableImages: Array.from({length: 555}, (_, i) => `choice${i + 1}.jpg`),

            init() {
                this.loadConfig();
                if (this.config.owner && this.config.repo && this.config.targetId) {
                    this.showTargetSection();
                }
            },

            saveConfig() {
                this.config.owner = document.getElementById('repoOwner').value.trim();
                this.config.repo = document.getElementById('repoName').value.trim();
                this.config.token = document.getElementById('githubToken').value.trim();
                this.config.centerLat = parseFloat(document.getElementById('centerLat').value);
                this.config.centerLon = parseFloat(document.getElementById('centerLon').value);
                this.config.targetId = document.getElementById('targetId').value.trim();
                
                if (!this.config.owner || !this.config.repo) {
                    alert('Please enter both repository owner and name');
                    return;
                }

                if (isNaN(this.config.centerLat) || isNaN(this.config.centerLon)) {
                    alert('Please enter valid latitude and longitude coordinates');
                    return;
                }

                if (!this.config.targetId) {
                    alert('Please enter a Target ID');
                    return;
                }

                localStorage.setItem('rvConfig', JSON.stringify(this.config));
                this.showTargetSection();
            },

            loadConfig() {
                const saved = localStorage.getItem('rvConfig');
                if (saved) {
                    this.config = JSON.parse(saved);
                    document.getElementById('repoOwner').value = this.config.owner;
                    document.getElementById('repoName').value = this.config.repo;
                    document.getElementById('centerLat').value = this.config.centerLat;
                    document.getElementById('centerLon').value = this.config.centerLon;
                    document.getElementById('targetId').value = this.config.targetId;
                }
            },

            showTargetSection() {
                document.getElementById('configSection').classList.add('hidden');
                document.getElementById('targetSection').classList.remove('hidden');
                document.getElementById('displayTargetId').textContent = this.config.targetId;
                document.getElementById('displayCenter').textContent = 
                    `${this.config.centerLat.toFixed(6)}, ${this.config.centerLon.toFixed(6)}`;
            },

            startSelection() {
                document.getElementById('targetSection').classList.add('hidden');
                this.gameState = {
                    selectedDigits: [],
                    currentPool: [],
                    currentSelection: null,
                    selectionStep: 0,
                    usedImages: [],
                    pendingGroups: null,
                    currentDigitIndex: 0
                };
                this.startNewDigit();
            },

            showPreparation() {
                document.getElementById('selectionSection').classList.add('hidden');
                document.getElementById('preparationSection').classList.remove('hidden');
            },

            proceedToSelection() {
                document.getElementById('preparationSection').classList.add('hidden');
                document.getElementById('selectionSection').classList.remove('hidden');
                
                if (this.gameState.pendingGroups) {
                    this.displayImageChoices(this.gameState.pendingGroups);
                    this.gameState.pendingGroups = null;
                } else {
                    this.startNewDigit();
                }
            },

            startNewDigit() {
                // Pool is 0-9 for each digit
                this.gameState.currentPool = Array.from({length: 10}, (_, i) => i);
                this.gameState.selectionStep = 0;
                this.showChoices();
            },

            showChoices() {
                const pool = this.gameState.currentPool;
                const digitsSelected = this.gameState.selectedDigits.length;
                
                document.getElementById('progressBar').style.width = `${(digitsSelected / 12) * 100}%`;
                document.getElementById('progressBar').textContent = `${digitsSelected}/12`;
                
                const digitType = this.getDigitType(digitsSelected);
                document.getElementById('selectionInfo').textContent = 
                    `Selecting digit ${digitsSelected + 1} of 12 (${digitType})`;
                
                if (pool.length === 1) {
                    this.gameState.selectedDigits.push(pool[0]);
                    this.gameState.currentDigitIndex++;
                    
                    if (this.gameState.selectedDigits.length === 12) {
                        this.completeSelection();
                    } else {
                        this.startNewDigit();
                    }
                    return;
                }
                
                const numGroups = Math.min(5, pool.length);
                const groups = this.divideIntoGroups(pool, numGroups);
                this.gameState.pendingGroups = groups;
                
                this.showPreparation();
            },

            getDigitType(index) {
                // Latitude: 6 digits (2 integer, 4 decimal after removing dot)
                // Longitude: 6 digits (2 integer, 4 decimal after removing dot)
                if (index < 6) {
                    if (index < 2) return 'Latitude integer part';
                    return 'Latitude decimal part';
                } else {
                    if (index < 8) return 'Longitude integer part';
                    return 'Longitude decimal part';
                }
            },

            divideIntoGroups(pool, numGroups) {
                const shuffled = [...pool];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                
                const groupSize = Math.ceil(shuffled.length / numGroups);
                const groups = [];
                
                for (let i = 0; i < numGroups; i++) {
                    const start = i * groupSize;
                    const end = Math.min(start + groupSize, shuffled.length);
                    if (start < shuffled.length) {
                        groups.push(shuffled.slice(start, end));
                    }
                }
                
                return groups.filter(g => g.length > 0);
            },

            displayImageChoices(groups) {
                const grid = document.getElementById('imageGrid');
                grid.innerHTML = '';
                this.gameState.currentSelection = null;
                document.getElementById('proceedBtn').disabled = true;
                
                groups.forEach((group, index) => {
                    const imageDiv = document.createElement('div');
                    imageDiv.className = 'image-choice';
                    imageDiv.dataset.group = JSON.stringify(group);
                    
                    const img = document.createElement('img');
                    img.src = this.getRandomImage();
                    img.alt = `Choice ${index + 1}`;
                    
                    imageDiv.appendChild(img);
                    imageDiv.onclick = () => this.selectImage(imageDiv, group);
                    grid.appendChild(imageDiv);
                });
            },

            getRandomImage() {
                const available = this.availableImages.filter(img => !this.gameState.usedImages.includes(img));
                if (available.length === 0) {
                    this.gameState.usedImages = [];
                    return this.availableImages[Math.floor(Math.random() * this.availableImages.length)];
                }
                const selected = available[Math.floor(Math.random() * available.length)];
                this.gameState.usedImages.push(selected);
                return selected;
            },

            selectImage(element, group) {
                document.querySelectorAll('.image-choice').forEach(el => {
                    el.classList.remove('selected');
                });
                
                element.classList.add('selected');
                this.gameState.currentSelection = group;
                document.getElementById('proceedBtn').disabled = false;
            },

            proceedToNext() {
                if (!this.gameState.currentSelection) return;
                
                this.gameState.currentPool = this.gameState.currentSelection;
                this.gameState.selectionStep++;
                this.showChoices();
            },

            digitsToCoordinate(digits) {
                // First 6 digits: latitude (format: XX.XXXX)
                // Last 6 digits: longitude (format: XX.XXXX)
                const latDigits = digits.slice(0, 6);
                const lonDigits = digits.slice(6, 12);
                
                // Construct latitude: ¬±2.5 km = ¬±0.0225 degrees approximately
                // Center lat integer part
                const centerLatInt = Math.floor(Math.abs(this.config.centerLat));
                const latSign = this.config.centerLat >= 0 ? 1 : -1;
                
                // Use selected digits to create offset within range
                const latIntPart = (latDigits[0] * 10 + latDigits[1]) % 5; // 0-4
                const latDecPart = latDigits[2] * 1000 + latDigits[3] * 100 + latDigits[4] * 10 + latDigits[5];
                const latOffset = (latIntPart * 10000 + latDecPart) / 100000; // 0.00000 to 0.04999
                const lat = latSign * (centerLatInt + (this.config.centerLat % 1) + (latOffset - 0.025));
                
                // Construct longitude similarly
                const centerLonInt = Math.floor(Math.abs(this.config.centerLon));
                const lonSign = this.config.centerLon >= 0 ? 1 : -1;
                
                const lonIntPart = (lonDigits[0] * 10 + lonDigits[1]) % 5; // 0-4
                const lonDecPart = lonDigits[2] * 1000 + lonDigits[3] * 100 + lonDigits[4] * 10 + lonDigits[5];
                const lonOffset = (lonIntPart * 10000 + lonDecPart) / 100000;
                const lon = lonSign * (centerLonInt + (this.config.centerLon % 1) + (lonOffset - 0.025));
                
                return { lat, lon };
            },

            async completeSelection() {
                document.getElementById('selectionSection').classList.add('hidden');
                document.getElementById('preparationSection').classList.add('hidden');
                document.getElementById('resultsSection').classList.remove('hidden');
                document.getElementById('loadingResults').classList.remove('hidden');
                
                try {
                    await this.submitToGitHub();
                    const analysis = await this.analyzeResults();
                    this.displayResults(analysis);
                } catch (error) {
                    console.error('Error:', error);
                    document.getElementById('resultsContent').innerHTML = 
                        `<div class="error"><strong>‚ùå Error</strong><br><br>${error.message}<br><br>Your selection was not saved. Please check your configuration and try again.</div>`;
                } finally {
                    document.getElementById('loadingResults').classList.add('hidden');
                    document.getElementById('resultsContent').classList.remove('hidden');
                }
            },

            async submitToGitHub() {
                const coord = this.digitsToCoordinate(this.gameState.selectedDigits);
                const coordString = `${coord.lat.toFixed(6)}, ${coord.lon.toFixed(6)}`;
                const digitString = this.gameState.selectedDigits.join('');
                
                const issueData = {
                    title: `[${this.config.targetId}] ${coordString}`,
                    body: `**Target ID:** ${this.config.targetId}\n**Coordinates:** ${coordString}\n**Digits:** ${digitString}\n**Timestamp:** ${new Date().toISOString()}\n**Center:** ${this.config.centerLat.toFixed(6)}, ${this.config.centerLon.toFixed(6)}`,
                    labels: ['remote-viewing', `target-${this.config.targetId}`]
                };
                
                const headers = {
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                };
                
                if (this.config.token) {
                    headers['Authorization'] = `token ${this.config.token}`;
                }
                
                const response = await fetch(
                    `https://api.github.com/repos/${this.config.owner}/${this.config.repo}/issues`,
                    {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(issueData)
                    }
                );
                
                if (!response.ok) {
                    let errorMessage = `GitHub API error (${response.status}): ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        if (errorData.message) {
                            errorMessage += `\n${errorData.message}`;
                        }
                    } catch (e) {}
                    
                    if (response.status === 404) {
                        errorMessage += '\n\nTip: Check that your repository owner and name are correct.';
                    } else if (response.status === 401) {
                        errorMessage += '\n\nTip: Your token may be invalid or expired.';
                    } else if (response.status === 403) {
                        errorMessage += '\n\nTip: Make sure your token has "repo" permissions.';
                    }
                    
                    throw new Error(errorMessage);
                }
                
                return await response.json();
            },

            async analyzeResults() {
                const headers = {
                    'Accept': 'application/vnd.github.v3+json'
                };
                
                if (this.config.token) {
                    headers['Authorization'] = `token ${this.config.token}`;
                }
                
                const response = await fetch(
                    `https://api.github.com/repos/${this.config.owner}/${this.config.repo}/issues?labels=target-${this.config.targetId}&state=all&per_page=100`,
                    { headers }
                );
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch issues (${response.status})`);
                }
                
                const issues = await response.json();
                
                const allCoordinates = [];
                const currentCoord = this.digitsToCoordinate(this.gameState.selectedDigits);
                
                issues.forEach(issue => {
                    const match = issue.title.match(/\[.*?\] ([-\d.]+), ([-\d.]+)/);
                    if (match) {
                        allCoordinates.push({
                            lat: parseFloat(match[1]),
                            lon: parseFloat(match[2]),
                            timestamp: issue.created_at
                        });
                    }
                });
                
                return {
                    currentCoord,
                    allCoordinates,
                    totalSelections: allCoordinates.length,
                    targetId: this.config.targetId,
                    centerLat: this.config.centerLat,
                    centerLon: this.config.centerLon
                };
            },

            displayResults(analysis) {
                const content = document.getElementById('resultsContent');
                let html = '<div class="results-section">';
                html += '<h2>üéØ Your Coordinate Selection</h2>';
                
                html += '<div class="coordinate-display current">';
                html += `<strong>Selected Coordinate:</strong><br>`;
                html += `${analysis.currentCoord.lat.toFixed(6)}, ${analysis.currentCoord.lon.toFixed(6)}`;
                html += '</div>';
                
                html += '<div id="map"></div>';
                
                html += '<div class="stat-item">';
                html += `<strong>Target ID:</strong> ${analysis.targetId}<br>`;
                html += `<strong>Total Selections:</strong> ${analysis.totalSelections}<br>`;
                html += `<strong>Center Point:</strong> ${analysis.centerLat.toFixed(6)}, ${analysis.centerLon.toFixed(6)}`;
                html += '</div>';
                
                if (analysis.allCoordinates.length > 1) {
                    html += '<button class="toggle-stats-btn" onclick="app.toggleCoordinates()">üìç View All Coordinates</button>';
                    html += '<div id="coordinatesSection" class="statistics-section hidden">';
                    html += '<h3>All Coordinates for this Target</h3>';
                    
                    analysis.allCoordinates.forEach((coord, index) => {
                        const isCurrent = Math.abs(coord.lat - analysis.currentCoord.lat) < 0.000001 && 
                                        Math.abs(coord.lon - analysis.currentCoord.lon) < 0.000001;
                        html += `<div class="coord-item ${isCurrent ? 'current' : ''}" onclick="app.zoomToCoordinate(${coord.lat}, ${coord.lon})">`;
                        html += `<strong>${isCurrent ? 'üéØ ' : ''}${coord.lat.toFixed(6)}, ${coord.lon.toFixed(6)}</strong><br>`;
                        html += `<span class="timestamp">${new Date(coord.timestamp).toLocaleString()}</span>`;
                        html += '</div>';
                    });
                    
                    html += '</div>';
                }
                
                html += '</div>';
                
                content.innerHTML = html;
                
                // Initialize map
                setTimeout(() => this.initMap(analysis), 100);
            },

            initMap(analysis) {
                const map = L.map('map').setView([analysis.centerLat, analysis.centerLon], 13);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);
                
                // Add center point marker
                L.circle([analysis.centerLat, analysis.centerLon], {
                    color: 'blue',
                    fillColor: '#3388ff',
                    fillOpacity: 0.2,
                    radius: 2500 // 2.5 km radius
                }).addTo(map).bindPopup('Target Center (5√ó5 km area)');
                
                // Add all coordinate markers
                analysis.allCoordinates.forEach((coord, index) => {
                    const isCurrent = Math.abs(coord.lat - analysis.currentCoord.lat) < 0.000001 && 
                                    Math.abs(coord.lon - analysis.currentCoord.lon) < 0.000001;
                    
                    const marker = L.marker([coord.lat, coord.lon], {
                        icon: L.divIcon({
                            className: 'custom-marker',
                            html: isCurrent ? 'üéØ' : 'üìç',
                            iconSize: [30, 30]
                        })
                    }).addTo(map);
                    
                    marker.bindPopup(`
                        <strong>${isCurrent ? 'Current Selection' : 'Previous Selection'}</strong><br>
                        ${coord.lat.toFixed(6)}, ${coord.lon.toFixed(6)}<br>
                        <small>${new Date(coord.timestamp).toLocaleString()}</small>
                    `);
                    
                    if (isCurrent) {
                        marker.openPopup();
                    }
                });
                
                this.currentMap = map;
            },

            zoomToCoordinate(lat, lon) {
                if (this.currentMap) {
                    this.currentMap.setView([lat, lon], 15);
                }
            },

            toggleCoordinates() {
                const section = document.getElementById('coordinatesSection');
                const btn = document.querySelector('.toggle-stats-btn');
                
                if (section.classList.contains('hidden')) {
                    section.classList.remove('hidden');
                    btn.textContent = 'üìç Hide All Coordinates';
                } else {
                    section.classList.add('hidden');
                    btn.textContent = 'üìç View All Coordinates';
                }
            },

            reset() {
                document.getElementById('resultsSection').classList.add('hidden');
                document.getElementById('preparationSection').classList.add('hidden');
                document.getElementById('configSection').classList.remove('hidden');
                this.gameState = {
                    selectedDigits: [],
                    currentPool: [],
                    currentSelection: null,
                    selectionStep: 0,
                    usedImages: [],
                    pendingGroups: null,
                    currentDigitIndex: 0
                };
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
